# 植物大战僵尸PVZ 第一阶段

[TOC]



## 课程设计分析

### 课程设计目标



### 课程设计基础内容



### 设计分析

*板块设计思路：让各个功能模块尽可能独立，通信和互相依赖是明确的。*

主要的板块分为植物、僵尸、和花园。

#### 花园

花园是整个游戏的基础界面，最基本的植物和僵尸的显示、分数的显示都由花园来完成。更进一步，购买植物后种植位置的选择，植物和僵尸攻击彼此时所依赖的位置信息也依赖于花园。所以花园的功能在本次设计中最为复杂，主要是在控制台的输出和交互（鼠标），以及处理和植物/僵尸关于位置信息的交互上。为了方便，商店的信息以及游戏整体状态的刷新也交给花园实现。

这里需要特别注意的是，花园关于位置信息的功能应当与植物/僵尸的攻击功能较好的区分开；即交互仅限于通知植物和僵尸攻击对象的信息，具体的攻击/受伤操作不应该由花园来完成，花园只是提供位置信息供植物和僵尸访问，根据是否会发生攻击取出指针后，剩下的攻击由植物和僵尸各自完成。



> 这里花园信息的吞吐量还不算很大，还有一种实现的方式是将植物和僵尸的信息直接交给对方，不经由花园处理，但是这样在僵尸动态移动的过程中，僵尸需要不断更新对植物距离的认知（只有相邻才会开始攻击即每一次移动都要判断是否相邻），这样大大增加了二者交互的频率，所以最后没有采用

#### 植物

为了在花园中统一表示所有植物，设计了一个总的父类Plant，其他植物都由plant继承而来。植物中统一的属性有生命值，购买需要的阳光数；攻击值取决于是否是攻击性的植物。

植物被攻击时需要获取僵尸的攻击值

##### Shooter & Bullet

本次需要实现简单的射手，射手通过子弹对僵尸攻击。子弹的移动与攻击和僵尸的移动与攻击类似

#### 僵尸

僵尸类统一的属性有生命值、攻击值和速度。与植物不同，僵尸有移动的功能，所以每一轮刷新时都要与花园进行位置更新的信息交互。



### 核心类的设计展示

#### 花园

位置信息：每行一个指针的vector 整个盘有三个vector，存在一个更大的vector中，

最初的初始化是用NULL初始化的遍历时需要注意。

### 程序的亮点与运行方法



### 遇到的问题与困难

#### 控制台应用的设计

https://zhuanlan.zhihu.com/p/148894267 对控制台有详细的介绍

输出上，从以下博客当中学习了相关window.h的API用法

https://www.cnblogs.com/flowingwind/p/8159035.html

https://blog.csdn.net/liluo_2951121599/article/details/66474233

采用的方法是先定位光标再定向的输出；美中不足的是会受到操作台显示大小的影响 需要在不同的平台提前设置

清空：一开始采用system("cls"),出现了句柄无效的问题；后来采用了填充空格并且把光标移到(0,0)的方式

需要在游戏Main中进行的设置

```c++
HANDLE hOutput = GetStdHandle(STD_OUTPUT_HANDLE);
HANDLE hIn = GetStdHandle(STD_INPUT_HANDLE);
SMALL_RECT rc = { 0,0, 119, 29 }; // 坐标位置结构体初始化
SetConsoleMode(hIn, ENABLE_WINDOW_INPUT | ENABLE_MOUSE_INPUT);//保证能读取鼠标
    SetConsoleWindowInfo(hOutput, true, &rc);
/*   */
CloseHandle(hOutput);
```

读取鼠标位置和键盘状态 

https://www.shuzhiduo.com/A/WpdKwD7ndV/  解锁鼠标的读取

https://blog.csdn.net/bnb45/article/details/8042819

#### 头文件的关系

出现了互相包含的情况，为了方便把游戏相关所谓类的定义放在了同一个头文件

#### 子弹和僵尸相对移动

完成子弹 一开始采用的是休眠 需要改成其他部分保持不动但是子弹在移动的状态；发现无法实现，把速度交给花园，由花园实现刷新。 花园提醒植物产生子弹

//僵尸的移动和子弹的移动有相似之处，由于时间单位由花园决定；所以僵尸和子弹的移动刷新由花园完成，速度则是僵尸和子弹自身的性质

找到一个可以在vector中一边遍历检查一边删除的方式 虽然想用队列但是需要遍历所以不行 另外为了防止意外情况需要遍历来检查是否攻击僵尸和越界 其实正常情况下可以不用

子弹和僵尸错位了？发现是遍历删除中if-else情况分类不当导致迭代器错位；

完成public状态下的刷新（ //消除死去的植物和僵尸√并且对僵尸计分
	//生成僵尸 按照时钟，不需要手动设置轮数//sleep100合适）



完成随机生成僵尸 平衡各个位置上的僵尸数目

僵尸到左侧向右侧数第二个格子就结束游戏: 注意刷新和显示的先后关系



//目前窗口是定死的 如果要修改大小需要重新计算间隔

完成商店

没有按照上下左右键来选择，创新:用户友好，直接选择地址

选购:目前是程序写死的选项，考虑能不能自动生成：采用宏？

可以多次选择位置 单击一个地块后，再次单击可以重新选择地块；如果需要确认选择，单机之后直接按回车同一个地块选择新的位置  商店的输出目前一样写死 而且用的字母

//完成的选择和种植 需要完善的部分还有：

确定何时能触发商店->在回合末尾检测一次键盘输入 如果符合条件就跳转进入商店 注意光标要在控制台内

亮点: 增加僵尸死亡和植物攻击的小提示

移动鼠标 才能捕获事件继续

//僵尸血量展示？

TODO：

实验代码打包重构

写实验报告

移动一次鼠标可以进行三个回合